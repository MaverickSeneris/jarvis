#!/bin/bash

echo "ğŸ¤– Jarvis AI Command Deck - Diagnostics & Maintenance"
echo "======================================================="
echo ""

### 1. Disk Usage
echo "ğŸ’¾ Disk Space:"
du -sh ~/jarvis ~/.local/share/piper ~/.ollama 2>/dev/null
echo ""

### 2. RAM + CPU Usage
echo "ğŸ§  RAM and CPU (top 3 resource hogs):"
ps -eo pid,comm,%mem,%cpu --sort=-%mem | head -n 4
echo ""

### 3. Python venv Check
echo "ğŸ Python venv:"
[[ -d ~/jarvis/venv ]] && echo "âœ… venv exists" || echo "âŒ Missing: python3 -m venv ~/jarvis/venv"
echo ""

### 4. Voice Tools
echo "ğŸ¤ Voice Tools:"
command -v whisper &>/dev/null && echo "âœ… Whisper installed" || echo "âŒ Whisper missing"
command -v piper &>/dev/null && echo "âœ… Piper installed" || echo "âŒ Piper missing"
echo ""

### 5. Ollama Model Check
echo "ğŸ§© Ollama Model:"
ollama list | grep jarvis &>/dev/null && echo "âœ… 'jarvis' model is available" || echo "âŒ 'jarvis' model is missing"
echo ""

### 6. Audio Device Check
echo "ğŸ”Š Audio Devices:"
arecord -l | grep card &>/dev/null && echo "âœ… Mic detected" || echo "âš ï¸ No mic found"
aplay -l | grep card &>/dev/null && echo "âœ… Speaker detected" || echo "âš ï¸ No speaker found"
echo ""

### 7. Aliases Check
echo "ğŸ”— Shell Aliases:"
alias | grep jarvis
echo ""

### 8. Temp File Cleanup
echo "ğŸ§¹ Temp Cleanup:"
if ls /tmp/voice.* &>/dev/null; then
  read -p "âš ï¸ Temp files found. Delete them now? [y/N]: " clean
  [[ "$clean" =~ ^[Yy]$ ]] && rm /tmp/voice.* && echo "âœ… Temp files deleted." || echo "ğŸ•¸ï¸ Skipped."
else
  echo "âœ… No temp files."
fi
echo ""

### 9. Ollama Token Speed Benchmark
echo "âš¡ Token Speed Benchmark:"
TEST_RESPONSE=$(echo "Say hello Jarvis" | ollama run jarvis --verbose 2>&1 | tee /tmp/jarvis-benchmark.log)
TOKENS_PER_SEC=$(grep -oP 'tokens\/s: \K[0-9.]+' /tmp/jarvis-benchmark.log | tail -n1)
[[ -z "$TOKENS_PER_SEC" ]] && echo "âŒ Could not retrieve token speed." || echo "âœ… Token speed: $TOKENS_PER_SEC tokens/s"
echo ""

### 10. Last Interaction Log
echo "ğŸ“œ Last Whisper Transcript:"
[[ -f /tmp/voice.txt ]] && tail -n5 /tmp/voice.txt || echo "âš ï¸ No recent voice input."
echo ""

### 11. Restart Option
read -p "ğŸ”„ Restart Ollama now? [y/N]: " restart
[[ "$restart" =~ ^[Yy]$ ]] && ollama stop jarvis && ollama run jarvis --verbose & echo "ğŸš€ Jarvis restarted." || echo "â­ï¸ Skipped."

echo ""
echo "âœ… All systems reviewed. Jarvis remains at your service, Sir Maverick."
